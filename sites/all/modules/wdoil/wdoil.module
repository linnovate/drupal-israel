<?php
// $Id:
/**
 * @file
 * The Doil module.
 */
function wdoil_link_alter(&$links, $node) {
  foreach ($links as $key => $value) {
    if (substr($key, 0, 14) == 'notifications_') {
      // Remove notificatinos links, so we can move them around
      unset ($links[$key]);
    }
  }
}

/**
 * Implementation of hook_block().
 */
function wdoil_block($op = 'list', $delta = 0) {
  global $user;
  if ($op == 'list') {
    $block[0]['info'] = t('doil - Hello visitor');
    return $block;
  }
  elseif ($op == 'view') {
    switch($delta) {
      case '0':
        $block['subject'] = t('Hello @visitor', array('@visitor' => !empty($user->uid) ? $user->name : t('visitor')));
        // Add user image if it exists.
        
        if (!empty($user->picture)) {
          $picture = file_create_url($user->picture);
          $alt = t("@user's picture", array('@user' => $user->name));
          $user_picture = theme('image', $picture, $alt, $alt, '', FALSE);
          $block['subject'] .= '<span id="doil-hello-visitor-picture>"'. $user_picture .'</span>';
        }
        
        // Add links for anon or authenticated user.
        $user_links = $user->uid ? t('<a href="@user-profile">Edit profile</a>', array('@user-profile' => url('user/'. $user->uid. '/edit'))) : t('<a href="@login">Login</a> | <a href="@register">Register</a>', array('@login' => url('user'), '@register' => url('user/register')));
        $block['subject'] .= '<span id="doil-hello-visitor>"'. $user_links .'</span>';

        // Get the connected users. Taken from user module.
        $connected = module_invoke('user', 'block', 'view', 3);
        // Remove the 'online user' h3 tag.
        $block['content'] .= preg_replace('/\<h3(.*)h3\>/', '', $connected['content']);

        // Get newset user. Taken from user module.
        $sql = "SELECT uid, name FROM {users} WHERE status != 0 AND access != 0 ORDER BY created DESC";
        $result = db_fetch_object(db_query($sql));
        $block['content'] .= t('!user is that latest member in the site.', array('!user' => theme('username', $result)));
      break;
    }
    return $block;
  }
}
